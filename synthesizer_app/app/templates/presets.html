{% extends "base.html" %}

{% block title %}Presets - Mobile Synthesizer{% endblock %}

{% block head_extra %}
<style>
  .form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239393c8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
</style>
{% endblock %}

{% block body %}
<div class="flex h-screen flex-col">
<header class="flex items-center justify-between border-b border-primary/20 p-4">
<h1 class="flex-1 text-center text-lg font-bold text-gray-900 dark:text-white">Presets</h1>
</header>
<div class="border-b border-primary/20">
<nav class="flex px-4">
<a class="border-b-2 border-transparent px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" href="/synthesizer">Synthesizer</a>
<a class="border-b-2 border-primary px-4 py-3 text-sm font-bold text-primary" href="/presets">Presets</a>
<a class="border-b-2 border-transparent px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" href="/mixer">Mixer</a>
<a class="border-b-2 border-transparent px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" href="/sequencer">Sequencer</a>
</nav>
</div>
<div class="border-b border-primary/20">
<nav id="preset-tabs" class="flex px-4">
<button data-tab="all" class="border-b-2 border-primary px-4 py-3 text-sm font-bold text-primary">All</button>
<button data-tab="factory" class="border-b-2 border-transparent px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">Factory</button>
<button data-tab="user" class="border-b-2 border-transparent px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">User</button>
</nav>
</div>
<main class="flex-1 overflow-y-auto p-4">
<div id="preset-list" class="space-y-2"></div>
<div id="preset-empty" class="hidden py-12 text-center text-gray-500 dark:text-gray-400">
<p class="text-lg">No presets yet</p>
<p class="mt-1 text-sm">Save a preset from the synthesizer page</p>
</div>
</main>
<footer class="border-t border-primary/20 bg-background-light dark:bg-background-dark/50">
<nav class="flex items-center justify-around px-4 py-2">
<a class="flex flex-col items-center gap-1 rounded-full p-2 text-gray-500 hover:text-primary dark:text-gray-400" href="/synthesizer">
<svg fill="currentColor" height="24" viewBox="0 0 256 256" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M224,115.55V208a16,16,0,0,1-16,16H168a16,16,0,0,1-16-16V168a8,8,0,0,0-8-8H112a8,8,0,0,0-8,8v40a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V115.55a16,16,0,0,1,5.17-11.78l80-75.48.11-.11a16,16,0,0,1,21.53,0,1.14,1.14,0,0,0,.11.11l80,75.48A16,16,0,0,1,224,115.55Z"></path>
</svg>
</a>
<a class="flex flex-col items-center gap-1 rounded-full p-2 text-primary" href="/presets">
<svg fill="currentColor" height="24" viewBox="0 0 256 256" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M184,32H72A16,16,0,0,0,56,48V224a8,8,0,0,0,12.24,6.78L128,193.43l59.77,37.35A8,8,0,0,0,200,224V48A16,16,0,0,0,184,32Zm0,177.57-51.77-32.35a8,8,0,0,0-8.48,0L72,209.57V48H184Z"></path>
</svg>
</a>
<a class="flex flex-col items-center gap-1 rounded-full p-2 text-gray-500 hover:text-primary dark:text-gray-400" href="/recording">
<svg fill="currentColor" height="24" viewBox="0 0 256 256" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M164.44,105.34l-48-32A8,8,0,0,0,104,80v64a8,8,0,0,0,12.44,6.66l48-32a8,8,0,0,0,0-13.32ZM120,129.05V95l25.58,17ZM216,40H40A16,16,0,0,0,24,56V168a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40Zm0,128H40V56H216V168Zm16,40a8,8,0,0,1-8,8H32a8,8,0,0,1,0-16H224A8,8,0,0,1,232,208Z"></path>
</svg>
</a>
<a class="flex flex-col items-center gap-1 rounded-full p-2 text-gray-500 hover:text-primary dark:text-gray-400" href="/profile">
<svg fill="currentColor" height="24" viewBox="0 0 256 256" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"></path>
</svg>
</a>
</nav>
</footer>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
import {
  getAllPresets,
  getFactoryPresets,
  getUserPresets,
  deletePreset,
} from "/static/js/ui/presets.js";

const list = document.getElementById("preset-list");
const empty = document.getElementById("preset-empty");
const tabs = document.getElementById("preset-tabs");
let activeTab = "all";

function renderPresets() {
  let presets;
  if (activeTab === "factory") presets = getFactoryPresets();
  else if (activeTab === "user") presets = getUserPresets();
  else presets = getAllPresets();

  list.innerHTML = "";
  if (presets.length === 0) {
    empty.classList.remove("hidden");
    return;
  }
  empty.classList.add("hidden");

  presets.forEach((p) => {
    const row = document.createElement("div");
    row.className = "flex items-center gap-3 rounded-lg bg-primary/5 p-3 dark:bg-primary/10";

    const info = document.createElement("div");
    info.className = "flex-1 min-w-0";
    info.innerHTML =
      '<p class="font-bold text-gray-900 dark:text-white truncate">' + escapeHtml(p.name) + "</p>" +
      '<p class="text-xs text-gray-500 dark:text-gray-400">' + p.category +
      " &middot; " + summarize(p.params) + "</p>";

    const loadBtn = document.createElement("a");
    loadBtn.href = "/synthesizer?preset=" + encodeURIComponent(p.name);
    loadBtn.className = "shrink-0 rounded bg-primary px-3 py-1.5 text-xs font-bold text-white hover:bg-primary/80";
    loadBtn.textContent = "Load";

    row.appendChild(info);
    row.appendChild(loadBtn);

    if (p.category === "user") {
      const delBtn = document.createElement("button");
      delBtn.className = "shrink-0 rounded bg-red-500/10 px-3 py-1.5 text-xs font-bold text-red-500 hover:bg-red-500/20";
      delBtn.textContent = "Delete";
      delBtn.addEventListener("click", () => {
        if (confirm('Delete "' + p.name + '"?')) {
          deletePreset(p.name);
          renderPresets();
        }
      });
      row.appendChild(delBtn);
    }

    list.appendChild(row);
  });
}

function summarize(params) {
  const parts = [params.osc1];
  if (params.osc2 !== "off") parts.push(params.osc2);
  if (params.osc3 !== "off") parts.push(params.osc3);
  return parts.join("+") + " | " + params.filterType + " " + Math.round(params.filterCutoff) + "Hz";
}

function escapeHtml(s) {
  const d = document.createElement("div");
  d.textContent = s;
  return d.innerHTML;
}

// Tab switching
tabs.addEventListener("click", (e) => {
  const btn = e.target.closest("[data-tab]");
  if (!btn) return;
  activeTab = btn.dataset.tab;
  tabs.querySelectorAll("button").forEach((b) => {
    const active = b.dataset.tab === activeTab;
    b.className = active
      ? "border-b-2 border-primary px-4 py-3 text-sm font-bold text-primary"
      : "border-b-2 border-transparent px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200";
  });
  renderPresets();
});

renderPresets();
</script>
{% endblock %}
